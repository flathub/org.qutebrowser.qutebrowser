app-id: org.qutebrowser.qutebrowser
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: qutebrowser
rename-icon: qutebrowser
base: io.qt.qtwebengine.BaseApp
base-version: '5.15'
finish-args:
  - --device=dri
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --filesystem=xdg-download
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
cleanup-commands:
  - /app/cleanup-BaseApp.sh
modules:

  - python3-colorama.json

  - name: python3-importlib-resources
    buildsystem: simple
    build-commands:
      - python setup.py build
      - python setup.py install --skip-build --prefix=/app --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c8/b2/d8263caf10de8632ef6756991d52e7fb0d8f5aa1e473344fad79b19ccb23/importlib_resources-5.1.2.tar.gz
        sha256: 642586fc4740bd1cad7690f836b3321309402b20b332529f25617ff18e8e1370
    modules:
      - python3-toml.json
      - python3-setuptools-scm.json

  - python3-Jinja2.json
  - python3-PyYAML.json
  # pygments is an optional dependecy. with the webengine backend is only used
  #   when viewing source with ':view-source --pygments'
  - python3-Pygments.json
  - python3-toml.json
  - python3-typing-extensions.json

  - name: python3-zipp
    buildsystem: simple
    build-commands:
      - python setup.py build
      - python setup.py install --skip-build --prefix=/app --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/38/f9/4fa6df2753ded1bcc1ce2fdd8046f78bd240ff7647f5c9bcf547c0df77e3/zipp-3.4.1.tar.gz
        sha256: 3607921face881ba3e026887d8150cca609d517579abe052ac81fc5aeffdbd76

  - name: python3-adblock
    only-arches:
      - x86_64
    buildsystem: simple
    build-commands:
      - pip3 install --exists-action=i --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} adblock --no-build-isolation
    sources:
      - type: file
        url: https://github.com/ArniDagur/python-adblock/releases/download/0.4.2/adblock-0.4.2-cp38-cp38-manylinux2010_x86_64.whl
        sha256: 2608b15ad58c034bfd5b4a6385c2052e2a2545b57e49d4508d5b14e491c15a2d

  - name: sip
    config-opts:
      - --no-dist-info
      - --no-stubs
      - --bindir=/app/bin
      - --destdir=/app/lib/python3.8/site-packages
      - --incdir=/app/include
      - --pyidir=/app/lib/python3.8/site-packages
      - --sipdir=/app/share/sip
      - --sip-module PyQt5.sip
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/sip/4.19.25/sip-4.19.25.tar.gz
        sha256: b39d93e937647807bac23579edbff25fe46d16213f708370072574ab1f1b4211
      - type: script
        commands:
          - processed=`sed -e 's|--prefix=/app||' <<< $@`
          - python3 configure.py $processed
        dest-filename: configure
    cleanup:
      - /bin
      - /include

  - name: pyqt5
    config-opts:
      - --assume-shared
      - --concatenate
      - --confirm-license
      - --no-designer-plugin
      - --no-dist-info
      - --no-docstrings
      - --no-qml-plugin
      - --no-qsci-api
      - --no-stubs
      - --no-tools
      - QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.8/'
      - QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.8/'
    build-options:
      arch:
        i386:
          config-opts:
            - --enable=QtCore
            - --enable=QtGui
            - --enable=QtNetwork
            - --enable=QtPrintSupport
            - --enable=QtWebChannel
            - --enable=QtWidgets
            - --enable=QtSql
            - --enable=QtOpenGL
            - --enable=QtQuick
            - --enable=QtQml
        x86_64:
          config-opts:
            - --enable=QtCore
            - --enable=QtGui
            - --enable=QtNetwork
            - --enable=QtPrintSupport
            - --enable=QtWebChannel
            - --enable=QtWidgets
            - --enable=QtSql
            - --enable=QtOpenGL
            - --enable=QtQuick
            - --enable=QtQml
    sources:
      - type: archive
        url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.15.4.tar.gz
        sha256: 2a69597e0dd11caabe75fae133feca66387819fc9bc050f547e5551bce97e5be
      - type: script
        commands:
        - processed=`sed -e 's|prefix|sysroot|' <<< $@`
        - python3 configure.py $processed
        dest-filename: configure
    cleanup:
      - /lib/debug
      - /share/sip

  - name: pyqt5-webengine
    build-options:
      env:
        - QMAKEPATH=/app/lib
    config-opts:
      - --concatenate
      - --no-dist-info
      - --no-docstrings
      - --no-qsci-api
      - --no-sip-files
      - --verbose
      - QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.8/'
      - QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.8/'
      - QMAKE_INCDIR+=/app/include/QtWebEngine
      - QMAKE_INCDIR+=/app/include/QtWebEngineCore
      - QMAKE_INCDIR+=/app/include/QtWebEngineWidgets
    sources:
      - type: archive
        url: https://pypi.python.org/packages/source/P/PyQtWebEngine/PyQtWebEngine-5.15.4.tar.gz
        sha256: cedc28f54165f4b8067652145aec7f732a17eadf6736835852868cf76119cc19
      - type: script
        commands:
          - processed=`sed -e 's|prefix|sysroot|' <<< $@`
          - python3 configure.py $processed
        dest-filename: configure
    cleanup:
      - /lib/debug

  - name: pdfjs
    buildsystem: simple
    build-commands:
      - unzip pdfjs-*.zip
      - mkdir /app/share/pdf.js
      - cp -R {LICENSE,build,web} /app/share/pdf.js
      - find /app/share/pdf.js -type f -exec chmod 644 {} \;
    sources:
      - type: file
        url: https://github.com/mozilla/pdf.js/releases/download/v2.6.347/pdfjs-2.6.347-dist.zip
        sha256: 5615181e6e1ee4d65b5945dd2c57ab82e5069480c068b75a2c2474134b4daecd

  - name: qutebrowser
    buildsystem: simple
    build-commands:
      - make --file misc/Makefile install PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/qutebrowser/qutebrowser/releases/download/v2.1.0/qutebrowser-2.1.0.tar.gz
        sha256: 1ddd373a4f31f16ba809870779918a8920b13dcb936f2d41ff4b27cfd4cae63b
      - type: patch
        path: 0001-Remove-manpage-support.patch
      - type: patch
        path: 0002-Fix-version-parsing-with-Flatpak.patch
      - type: patch
        path: 0003-ipc-socket-workaround.patch
