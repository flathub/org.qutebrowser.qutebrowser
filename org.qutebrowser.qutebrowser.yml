app-id: org.qutebrowser.qutebrowser
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node14
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '21.08'
    add-ld-path: .
    no-autodownload: true
command: qutebrowser
rename-icon: qutebrowser
base: io.qt.qtwebengine.BaseApp
base-version: 5.15-21.08
finish-args:
  - --device=dri
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-videos
  - --filesystem=xdg-run/pipewire-0:ro
  - --own-name=org.kde.*
  - --own-name=org.mpris.MediaPlayer2.qutebrowser.*
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
  - --system-talk-name=org.freedesktop.UPower
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
modules:
  - name: qutebrowser
    buildsystem: simple
    build-commands:
      - python3 scripts/asciidoc2html.py
      - make --file misc/Makefile install PREFIX=/app
      - mkdir -p /app/lib/ffmpeg
    run-tests: false
    test-commands:
      - |
        export QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
        export PYTHONPATH=.
        # verbose output:  -v -s --no-qt-log
        pytest --qute-bdd-webengine
    sources:
      - type: git
        url: https://github.com/qutebrowser/qutebrowser.git
        tag: v2.4.0
        commit: 36ffff2f6b3b77f900cd503b86ec9cfd9497e983
        x-checker-data:
          type: json
          url: https://api.github.com/repos/qutebrowser/qutebrowser/releases/latest
          tag-query: .tag_name
          version-query: $tag
          timestamp-query: .published_at
    modules:
      - asciidoc/asciidoc.json
# TODO: add here pyperclip backends?
# TODO: add here dependencies of pykeepass
      - name: python-zipp
        # added here as since 3.6.0 pip fails and complains about mismatch of version in metadata with filename version
        # need to be before python-setuptools-scm
        buildsystem: simple
        build-commands:
          - python setup.py build
          - python setup.py install --skip-build --prefix=/app --root=/ --optimize=1
        sources:
          - type: archive
            url: https://github.com/jaraco/zipp/archive/v3.6.0/zipp-3.6.0.tar.gz
            sha256: fd1af7ebc49a73dd0cd35f31d44a28022566e5114bdef64129fab0d9dc524486
            x-checker-data:
              type: anitya
              project-id: 63514
              stable-only: true
              url-template: https://github.com/jaraco/zipp/archive/v$version/zipp-$version.tar.gz
      # https://github.com/hukkin/tomli/issues/130
      - python-setuptools-scm/python-setuptools-scm.json
      # generated with flatpak-pip-generator from requirements.txt
      - python-colorama/python-colorama.json
      - python-jinja/python-jinja.json
      # pygments is an optional dependecy. with the webengine backend is only used
      #   when viewing source with ':view-source --pygments'
      #   is availble in the sdk but not in the runtime so it's not being included by flatpak-pip-generator
      - python-pygments/python-pygments.json
      - python-pyyaml/python-pyyaml.json
      - python-typing_extensions/python-typing_extensions.json
        # only extensions dependencies
      - python-dependencies.json
      - python-adblock/python-adblock.json
      - pyqt5/pyqt5-webengine.json
      - pdfjs/pdfjs.json
      # userscripts/password_fill secret backend
      - libsecret/libsecret.json
      # TODO: f-e-d-c for tests
#     - tests/tests-dependencies.json
