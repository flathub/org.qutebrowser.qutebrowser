app-id: org.qutebrowser.qutebrowser
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node14
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '21.08'
    add-ld-path: .
    no-autodownload: true
command: /app/bin/qutebrowser
rename-icon: qutebrowser
base: io.qt.qtwebengine.BaseApp
base-version: 5.15-21.08
finish-args:
  - --device=dri
  - --env=PATH=/app/bin:/usr/bin:/app/share/perl6/site/bin:/var/data/bin:/var/data/python/bin
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-videos
  - --filesystem=xdg-run/pipewire-0:ro
  - --filesystem=/run/.heim_org.h5l.kcm-socket
  - --own-name=org.kde.*
  - --own-name=org.mpris.MediaPlayer2.qutebrowser.*
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
  - --system-talk-name=org.freedesktop.UPower
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
modules:
  - name: qutebrowser
    buildsystem: simple
    build-commands:
      - python3 scripts/asciidoc2html.py
      - make --file misc/Makefile install PREFIX=/app
      - mkdir -p /app/lib/ffmpeg
      - sed -i '/^Exec=qutebrowser/ s@=@=/app/bin/@' /app/share/applications/${FLATPAK_ID}.desktop
    run-tests: false
    test-commands:
      - |
        export QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
        export PYTHONPATH=.
        # verbose output:  -v -s --no-qt-log
        pytest --qute-bdd-webengine
    sources:
      - type: git
        url: https://github.com/qutebrowser/qutebrowser.git
        tag: v2.4.0
        commit: 36ffff2f6b3b77f900cd503b86ec9cfd9497e983
        x-checker-data:
          type: json
          url: https://api.github.com/repos/qutebrowser/qutebrowser/releases/latest
          tag-query: .tag_name
          version-query: $tag
          timestamp-query: .published_at
      - type: patch
        path: flatpak-system_data.patch
    modules:
      - asciidoc/asciidoc.json
      - name: python-zipp
        # added here as since 3.6.0 pip fails and complains about mismatch of version in metadata with filename version
        # need to be before python-setuptools-scm
        buildsystem: simple
        build-commands:
          - python setup.py build
          - python setup.py install --skip-build --prefix=/app --root=/ --optimize=1
        sources:
          - type: archive
            url: https://github.com/jaraco/zipp/archive/v3.7.0/zipp-3.7.0.tar.gz
            sha256: acea738e563c002fcc2df6068ce466f7599ac39700e36a96de1e3dc8adb94c05
            x-checker-data:
              type: anitya
              project-id: 63514
              stable-only: true
              url-template: https://github.com/jaraco/zipp/archive/v$version/zipp-$version.tar.gz
      - python-setuptools-scm/python-setuptools-scm.json # https://github.com/hukkin/tomli/issues/130
      - python-colorama/python-colorama.json
      - python-jinja/python-jinja.json
      # pygments required by format_json userscript, and optional for viewing source with ':view-source --pygments',
      #   available in the sdk but not in the runtime
      - python-pygments/python-pygments.json
      - python-pyyaml/python-pyyaml.json
      - python-typing_extensions/python-typing_extensions.json
      - python-adblock/python-adblock.json
      # faster local rebuilds with pre-build python-adblock module
      #- python-adblock/python-adblock-bin.json
      - pyqt5/pyqt5-webengine.json
      - pdfjs/pdfjs.json
      - userscripts-dependencies/userscripts-dependencies.yaml
      - flatpak-spawn-wrapper/flatpak-spawn-wrapper.json
      # TODO: f-e-d-c for tests
      #- tests/tests-dependencies.json
