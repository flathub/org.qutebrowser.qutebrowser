app-id: org.qutebrowser.qutebrowser
runtime: org.kde.Platform
runtime-version: '6.3'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node14
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '21.08'
    add-ld-path: .
    no-autodownload: true
  org.qutebrowser.qutebrowser.Userscripts:
    directory: userscripts
    version: beta
    add-ld-path: lib
    no-autodownload: true
command: /app/bin/qutebrowser
rename-icon: qutebrowser
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.3'
# pyqt-shared-module
#base: io.qt.qtwebengine.BaseApp
#build-options:
#  env:
#    - ENABLED_PYQT_BINDINGS=QtCore:QtDBus:QtGui:QtNetwork:QtOpenGL:QtPrintSupport:QtQml:QtQuick:QtSql:QtTest:QtWebChannel:QtWidgets
finish-args:
  - --device=dri
  - --env=PATH=/app/bin:/app/userscripts/bin:/usr/bin:/app/userscripts/share/perl6/site/bin:/var/data/bin:/var/data/python/bin
  - --env=PYTHONPATH=/app/userscripts/lib/python/site-packages
  - --env=PYTHONUSERBASE=/var/data/python
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-videos
  - --filesystem=xdg-run/pipewire-0:ro
  - --filesystem=/run/.heim_org.h5l.kcm-socket
  - --own-name=org.kde.*
  - --own-name=org.mpris.MediaPlayer2.chromium.*
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
  - --system-talk-name=org.freedesktop.UPower
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
  # avoid dependency of python modules from extension on module from the app
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/packaging
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/packaging-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/ply
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/ply-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/pyparsing
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/pyparsing-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/toml
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/toml-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/tomli
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/tomli-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/typing_extensions-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/typing_extensions.py
modules:
  - name: qutebrowser
    buildsystem: simple
    build-commands:
      # avoid installing as zip file
      - sed -i '/zip_safe=/ s/True/False/' setup.py
      - python3 scripts/asciidoc2html.py
      - make --file misc/Makefile install PREFIX=${FLATPAK_DEST}
      - install -dm755 ${FLATPAK_DEST}/{lib/ffmpeg,userscripts}
      - sed -i '/^Exec=qutebrowser/ s@=@='${FLATPAK_DEST}'/bin/@' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    run-tests: false
    test-commands:
      - |
        export QTWEBENGINEPROCESS_PATH=${FLATPAK_DEST}/bin/QtWebEngineProcess
        export PYTHONPATH=.
        # Flathub CI has XDG_RUNTIME_DIR mode bits set to 0755
        if [ "$(stat --format=%04a $XDG_RUNTIME_DIR)" = "0755" ]; then
          chmod -v 0700 $XDG_RUNTIME_DIR
        fi
        # verbose output:  -v -s --no-qt-log
        # workaround for Flathub CI's inability to detect job failure and stopping it
        pytest --qute-backend=webengine || true
    sources:
      - type: git
        url: https://github.com/qutebrowser/qutebrowser.git
        #branch: qt6-v2
        commit: dfde9798074eb5ed192ff8ba074032e8a42b219a
        x-checker-data:
          is-main-source: true
          type: json
          url: https://api.github.com/repos/qutebrowser/qutebrowser/commits?sha=qt6-v2&per_page=1
          commit-query: .[].sha
          version-query: .[].sha[0:8]
          timestamp-query: .[].commit.committer.date
      - type: patch
        path: qutebrowser-appdata-wiki.patch
    modules:
     #- pyqt-shared-module.json
      - asciidoc/asciidoc.json
      - python-jinja/python-jinja.json
      # pygments required by format_json userscript, and optional for viewing source with ':view-source --pygments',
      #   available in the sdk but not in the runtime
      - python-pygments/python-pygments.json
      - python-pyyaml/python-pyyaml.json
      - python-adblock/python-adblock.json
      #- python-adblock-bin/python-adblock-bin.json
      - pdfjs/pdfjs.json
      - flatpak-spawn-wrapper/flatpak-spawn-wrapper.json
      # TODO: f-e-d-c for tests
      #- tests/tests-dependencies.json
