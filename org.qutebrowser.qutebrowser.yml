app-id: org.qutebrowser.qutebrowser
runtime: org.kde.Platform
runtime-version: '6.2'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node14
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '21.08'
    add-ld-path: .
    no-autodownload: true
  org.qutebrowser.qutebrowser.Userscripts:
    directory: userscripts
    version: '6.2'
    add-ld-path: lib
    no-autodownload: false
command: /app/bin/qutebrowser
rename-icon: qutebrowser
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.2'
# pyqt-shared-module
#base: io.qt.qtwebengine.BaseApp
#build-options:
#  env:
#    - ENABLED_PYQT_BINDINGS=QtCore:QtDBus:QtGui:QtNetwork:QtOpenGL:QtPrintSupport:QtQml:QtQuick:QtSql:QtTest:QtWebChannel:QtWidgets
finish-args:
  - --device=dri
  - --env=PATH=/app/bin:/app/userscripts/bin:/usr/bin:/app/userscripts/share/perl6/site/bin:/var/data/bin:/var/data/python/bin
  - --env=PYTHONPATH=/app/userscripts/lib/python/site-packages
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-videos
  - --filesystem=xdg-run/pipewire-0:ro
  - --filesystem=/run/.heim_org.h5l.kcm-socket
  - --own-name=org.kde.*
  - --own-name=org.mpris.MediaPlayer2.qutebrowser.*
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
  - --system-talk-name=org.freedesktop.UPower
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
  # avoid dependency of python modules from extension on module from the app
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/packaging
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/packaging-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/ply
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/ply-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/pyparsing
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/pyparsing-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/toml
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/toml-*.dist-info
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/tomli
  - rm -vrf ${FLATPAK_DEST}/lib/python*/site-packages/tomli-*.dist-info
modules:
  - name: qutebrowser
    buildsystem: simple
    build-commands:
      - python3 scripts/asciidoc2html.py
      - make --file misc/Makefile install PREFIX=/app
      - install -dm755 /app/{lib/ffmpeg,userscripts}
      - sed -i '/^Exec=qutebrowser/ s@=@=/app/bin/@' /app/share/applications/${FLATPAK_ID}.desktop
    run-tests: false
    test-commands:
      - |
        export QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
        export PYTHONPATH=.
        # verbose output:  -v -s --no-qt-log
        # workaround for Flathub CI's inability to detect job failure and stopping it
        pytest --qute-backend=webengine || true
    sources:
      - type: git
        url: https://github.com/qutebrowser/qutebrowser.git
        tag: v2.5.0
        commit: 01a402dcfc76c24d872a6d6021decc4c1542e197
        x-checker-data:
          type: json
          url: https://api.github.com/repos/qutebrowser/qutebrowser/releases/latest
          tag-query: .tag_name
          version-query: $tag
          timestamp-query: .published_at
    modules:
     #- name: pyqt-shared-module
     #  buildsystem: simple
     #  build-commands:
     #    - mv ${FLATPAK_DEST}/cleanup-BaseApp{,-QtWebEngine}.sh
     #    - install -Dm755 cleanup.sh ${FLATPAK_DEST}/cleanup-BaseApp.sh
     #  sources:
     #    - type: file
     #      path: pyqt-shared-module/cleanup.sh
     #  modules:
     #    - pyqt-shared-module/python-packaging-tools/python-packaging-tools.json
     #    - pyqt-shared-module/pyqt/pyqt.json
     #    - pyqt-shared-module/pyqt-webengine/pyqt-webengine.json
      - asciidoc/asciidoc.json
      - python-colorama/python-colorama.json
      - python-jinja/python-jinja.json
      # pygments required by format_json userscript, and optional for viewing source with ':view-source --pygments',
      #   available in the sdk but not in the runtime
      - python-pygments/python-pygments.json
      - python-pyyaml/python-pyyaml.json
      #- python-adblock/python-adblock.json
      - python-adblock-bin/python-adblock-bin.json
      - pdfjs/pdfjs.json
      - flatpak-spawn-wrapper/flatpak-spawn-wrapper.json
      # TODO: f-e-d-c for tests
      #- tests/tests-dependencies.json
